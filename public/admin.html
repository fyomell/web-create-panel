<!DOCTYPE html>
<html lang="id">
<head>
    </head>
<body>
    <script type="module">
        import { auth, db } from './firebase-config.js';
        import { onAuthStateChanged, getIdToken } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { doc, getDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        
        let idToken = null;
        let currentUser = null;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const userDocRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(userDocRef);
                
                if (!docSnap.exists() || docSnap.data().role !== 'owner') {
                    alert('Akses ditolak! Hanya untuk owner.');
                    return window.location.replace('/index.html');
                }
                
                idToken = await getIdToken(user);
                loadAllUsers();
            } else {
                window.location.replace('/login.html');
            }
        });

        async function loadAllUsers() {
            const tableBody = document.getElementById('usersTable').querySelector('tbody');
            try {
                const response = await fetch('/api/admin/getAllUsers', {
                    headers: { 'Authorization': `Bearer ${idToken}` }
                });
                if (!response.ok) throw new Error('Gagal memuat data user.');
                const users = await response.json();
                tableBody.innerHTML = '';
                users.forEach(user => {
                    if (user.role === 'owner') return;
                    const tr = document.createElement('tr');
                    const isBanned = user.banned;
                    tr.innerHTML = `
                        <td>${user.username}</td>
                        <td>${user.role}</td>
                        <td>${user.panelCount || 0}</td>
                        <td>${isBanned ? '<span style="color:var(--danger-color);">Banned</span>' : '<span style="color:#4caf50;">Aktif</span>'}</td>
                        <td class="actions">
                            ${user.role !== 'web_reseller' ? `<button class="btn-make-reseller-web" onclick="window.setUserRole('${user.username}', 'web_reseller')">Jadi Reseller Web</button>` : ''}
                            ${user.role === 'web_reseller' ? `<button class="btn-make-user" onclick="window.setUserRole('${user.username}', 'user')">Jadi User Biasa</button>` : ''}
                            ${!isBanned ? `<button class="btn-ban" onclick="window.setBanStatus('${user.username}', true)">Ban</button>` : ''}
                            ${isBanned ? `<button class="btn-unban" onclick="window.setBanStatus('${user.username}', false)">Unban</button>` : ''}
                        </td>
                    `;
                    tableBody.appendChild(tr);
                });
            } catch (error) {
                tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center; color: var(--danger-color);">${error.message}</td></tr>`;
            }
        }

        async function updateUserState(username, state, password = null) {
            let confirmationMessage = `Apakah Anda yakin ingin mengubah status user ${username}?`;
            if (state.role === 'web_reseller') {
                confirmationMessage = `Anda akan menjadikan ${username} sebagai Reseller Web. Lanjutkan?`;
            }
            if (!confirm(confirmationMessage)) return;

            try {
                const bodyPayload = { username, ...state };
                if (password) {
                    bodyPayload.password = password;
                }

                const response = await fetch('/api/admin/setUserState', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${idToken}` },
                    body: JSON.stringify(bodyPayload)
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message);
                alert(result.message);
                loadAllUsers();
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }
        
        window.setUserRole = (username, role) => {
            if (role === 'web_reseller') {
                const password = prompt(`Masukkan password untuk Reseller Web "${username}":`);
                if (password && password.length >= 6) {
                    updateUserState(username, { role }, password);
                } else if (password !== null) { // Jika user tidak klik cancel tapi passwordnya kurang
                    alert("Password minimal 6 karakter.");
                }
            } else {
                updateUserState(username, { role });
            }
        };

        window.setBanStatus = (username, banned) => updateUserState(username, { banned });
    </script>
</body>
</html>